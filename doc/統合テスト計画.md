# StatVizForge 統合テスト計画

## 1. 概要

本ドキュメントは、StatVizForgeプロジェクトの全体的なテスト計画を定義します。バックエンドAPI、フロントエンド、およびシステム全体の統合テストを含みます。

### 1.1 テスト目的
- システム全体の品質保証
- API仕様の準拠性確認
- エンドツーエンドの機能検証
- パフォーマンスとセキュリティの保証

### 1.2 テスト範囲
- バックエンドAPIテスト
- フロントエンドテスト（別途詳細計画あり）
- 統合テスト
- パフォーマンステスト
- セキュリティテスト

## 2. バックエンドAPIテスト計画

### 2.1 テスト環境
- **言語/フレームワーク**: Python 3.12 / Django 5.2.4
- **テストフレームワーク**: Django Test Framework, pytest
- **APIテストツール**: Django REST framework test client
- **モックツール**: unittest.mock
- **カバレッジツール**: coverage.py

### 2.2 APIエンドポイントテスト

#### 2.2.1 プロジェクト管理API

##### GET /api/projects/
**テストケース**:
- [ ] 正常系: プロジェクト一覧の取得
- [ ] プロジェクトが0件の場合の応答
- [ ] 言語パラメータ(lang=ja/en/zh)の動作確認
- [ ] レスポンス形式の検証（JSON構造）

##### POST /api/projects/
**テストケース**:
- [ ] 正常系: 新規プロジェクト作成
- [ ] 必須フィールド欠如時のバリデーション
- [ ] フォルダ名重複時の409エラー
- [ ] プロジェクト名の文字数制限（255文字）
- [ ] タグの配列処理
- [ ] フォルダ構造の自動生成確認
- [ ] project.jsonファイルの作成確認

##### GET /api/projects/{id}/
**テストケース**:
- [ ] 正常系: プロジェクト詳細取得
- [ ] 存在しないIDの404エラー
- [ ] 不正なUUID形式のエラー処理

##### PUT /api/projects/{id}/
**テストケース**:
- [ ] 正常系: プロジェクト情報更新
- [ ] 部分更新（PATCH）の動作
- [ ] 存在しないIDの404エラー
- [ ] バリデーションエラー

##### DELETE /api/projects/{id}/
**テストケース**:
- [ ] 正常系: プロジェクト削除
- [ ] zipアーカイブの作成確認
- [ ] trash-registry.jsonへの記録
- [ ] 存在しないIDの404エラー

##### GET /api/projects/deleted/
**テストケース**:
- [ ] 削除済みプロジェクト一覧取得
- [ ] trash-registry.jsonの読み込み
- [ ] 空リストの処理

##### POST /api/projects/{id}/restore/
**テストケース**:
- [ ] 正常系: プロジェクト復元
- [ ] zipファイルの展開
- [ ] フォルダ名重複時のエラー
- [ ] 存在しない削除済みプロジェクト

##### GET /api/projects/validate-registry/
**テストケース**:
- [ ] レジストリ整合性チェック
- [ ] 自動修復機能の動作
- [ ] 問題検出と報告

#### 2.2.2 ファイル管理API

##### GET /api/files/tree/{project_folder}/
**テストケース**:
- [ ] 正常系: ディレクトリツリー取得
- [ ] 空ディレクトリの処理
- [ ] 大量ファイルのパフォーマンス
- [ ] 存在しないプロジェクトの404エラー

##### POST /api/files/upload/{project_folder}/
**テストケース**:
- [ ] 単一ファイルアップロード
- [ ] 複数ファイル同時アップロード
- [ ] ファイルサイズ制限
- [ ] 許可されていないファイル形式
- [ ] パス指定によるアップロード
- [ ] ディレクトリ作成を伴うアップロード

##### GET /api/files/search/{project_folder}/
**テストケース**:
- [ ] ファイル名検索
- [ ] ファイル内容検索
- [ ] 両方での検索（name/content/both）
- [ ] 最大結果数の制限
- [ ] 検索クエリのエスケープ処理

##### DELETE /api/files/delete/{project_folder}/
**テストケース**:
- [ ] ファイル削除
- [ ] ディレクトリ削除（再帰的）
- [ ] コメントの連動削除
- [ ] 存在しないパスのエラー

##### POST /api/files/move/{project_folder}/
**テストケース**:
- [ ] ファイル移動
- [ ] ディレクトリ移動
- [ ] 同名ファイルの上書き確認
- [ ] コメントの連動移動
- [ ] 不正なパスのエラー処理

##### POST /api/files/mkdir/{project_folder}/
**テストケース**:
- [ ] ディレクトリ作成
- [ ] 既存ディレクトリの重複エラー
- [ ] 親ディレクトリが存在しない場合

##### GET /api/files/table/{project_folder}/
**テストケース**:
- [ ] ファイル一覧のテーブル形式取得
- [ ] ファイル情報の完全性
- [ ] ソート順序

##### GET /api/files/column-types/{project_folder}/
**テストケース**:
- [ ] CSVファイルのカラムタイプ取得
- [ ] 非CSVファイルのエラー処理
- [ ] 大規模CSVのパフォーマンス

#### 2.2.3 ファイル説明・タグ管理API

##### GET /api/files/descriptions/{project_folder}/
**テストケース**:
- [ ] ファイル説明の取得
- [ ] 説明が存在しない場合
- [ ] 不正なファイルパス

##### POST /api/files/descriptions/{project_folder}/
**テストケース**:
- [ ] 新規説明の保存
- [ ] 既存説明の更新
- [ ] 長文説明の処理
- [ ] タグの同時保存

##### GET /api/files/tags/{project_folder}/
**テストケース**:
- [ ] タグの階層構造取得
- [ ] タグが存在しない場合

##### POST /api/files/tags/{project_folder}/
**テストケース**:
- [ ] タグの新規保存
- [ ] タグの更新
- [ ] 階層構造の保持
- [ ] 不正なタグ形式

##### GET /api/files/search-by-tags/{project_folder}/
**テストケース**:
- [ ] 単一タグ検索
- [ ] 複数タグ検索（OR条件）
- [ ] 複数タグ検索（AND条件）
- [ ] 存在しないタグ

#### 2.2.4 コメント管理API

##### GET /api/files/comments/{project_folder}/
**テストケース**:
- [ ] 全コメント取得
- [ ] ファイル別コメント取得
- [ ] コメントが0件の場合

##### POST /api/files/comments/{project_folder}/
**テストケース**:
- [ ] コメント追加
- [ ] 必須フィールドの検証
- [ ] 長文コメントの処理

##### PUT /api/files/comments/{project_folder}/{comment_id}/
**テストケース**:
- [ ] コメント更新
- [ ] 存在しないコメントID
- [ ] 権限チェック（将来実装）

##### DELETE /api/files/comments/{project_folder}/{comment_id}/
**テストケース**:
- [ ] コメント削除
- [ ] 存在しないコメントID
- [ ] カスケード削除の確認

#### 2.2.5 JupyterLab管理API

##### POST /api/jupyter/start/
**テストケース**:
- [ ] JupyterLab起動
- [ ] 既に起動中の場合
- [ ] ポート競合の処理
- [ ] プロジェクトフォルダの検証

##### POST /api/jupyter/stop/
**テストケース**:
- [ ] JupyterLab停止
- [ ] 起動していない場合
- [ ] プロセス終了の確認

##### GET /api/jupyter/status/
**テストケース**:
- [ ] 起動状態の取得
- [ ] URL情報の正確性
- [ ] プロセス情報の取得

#### 2.2.6 システムAPI

##### GET /api/server-info/
**テストケース**:
- [ ] サーバー情報取得
- [ ] 環境変数の反映
- [ ] バージョン情報の正確性

### 2.3 エラーハンドリングテスト

#### 2.3.1 共通エラー処理
- [ ] 400 Bad Request: 不正なリクエスト
- [ ] 401 Unauthorized: 認証エラー（将来実装）
- [ ] 403 Forbidden: 権限エラー（将来実装）
- [ ] 404 Not Found: リソース不在
- [ ] 409 Conflict: リソース競合
- [ ] 500 Internal Server Error: サーバーエラー

#### 2.3.2 言語別エラーメッセージ
- [ ] 日本語エラーメッセージ (lang=ja)
- [ ] 英語エラーメッセージ (lang=en)
- [ ] 中国語エラーメッセージ (lang=zh)
- [ ] デフォルト言語（英語）

### 2.4 データ整合性テスト

#### 2.4.1 ファイルシステムとの整合性
- [ ] projects-registry.jsonと実フォルダの同期
- [ ] trash-registry.jsonとtrashフォルダの同期
- [ ] コメントファイルとファイルシステムの整合性

#### 2.4.2 トランザクション処理
- [ ] プロジェクト作成の原子性
- [ ] ファイル移動の原子性
- [ ] 削除処理のロールバック

## 3. 統合テスト計画

### 3.1 エンドツーエンドシナリオ

#### 3.1.1 プロジェクトライフサイクル
1. [ ] プロジェクト作成
2. [ ] ファイルアップロード
3. [ ] ファイル説明・タグ追加
4. [ ] コメント追加
5. [ ] ファイル検索
6. [ ] JupyterLab起動・実行
7. [ ] プロジェクト削除
8. [ ] プロジェクト復元

#### 3.1.2 マルチユーザーシナリオ（将来実装）
- [ ] 同時アクセス処理
- [ ] ロック機構の動作
- [ ] 競合状態の解決

### 3.2 APIとフロントエンドの統合
- [ ] APIレスポンスの画面表示
- [ ] エラーハンドリングの連携
- [ ] リアルタイム更新（WebSocket使用時）

## 4. パフォーマンステスト計画

### 4.1 負荷テスト

#### 4.1.1 API負荷テスト
- **ツール**: Locust, JMeter
- **シナリオ**:
  - [ ] 100同時ユーザーでのプロジェクト一覧取得
  - [ ] 大容量ファイル（100MB）のアップロード
  - [ ] 1000ファイルを含むディレクトリツリー取得
  - [ ] 10000件のファイル検索

#### 4.1.2 レスポンスタイム目標
- プロジェクト一覧: < 500ms
- ファイルツリー（100ファイル）: < 1s
- ファイル検索: < 2s
- ファイルアップロード（10MB）: < 5s

### 4.2 ストレステスト
- [ ] メモリリーク検出
- [ ] 長時間稼働テスト（24時間）
- [ ] リソース枯渇時の挙動

## 5. セキュリティテスト計画

### 5.1 入力検証テスト
- [ ] SQLインジェクション対策
- [ ] XSS（クロスサイトスクリプティング）対策
- [ ] パストラバーサル対策
- [ ] コマンドインジェクション対策

### 5.2 ファイルアップロードセキュリティ
- [ ] 実行可能ファイルの制限
- [ ] ファイルサイズ制限の強制
- [ ] MIMEタイプの検証
- [ ] ウイルススキャン（将来実装）

### 5.3 認証・認可（将来実装）
- [ ] JWT トークンの検証
- [ ] セッション管理
- [ ] CSRF対策
- [ ] レート制限

### 5.4 データ保護
- [ ] センシティブ情報のマスキング
- [ ] ログファイルのセキュリティ
- [ ] バックアップファイルのアクセス制御

## 6. テスト自動化戦略

### 6.1 CI/CDパイプライン
```yaml
stages:
  - lint
  - unit-test
  - integration-test
  - e2e-test
  - performance-test
  - deploy
```

### 6.2 テスト実行タイミング
- **コミット時**: Lintチェック、単体テスト
- **プルリクエスト時**: 統合テスト、APIテスト
- **デイリービルド**: 全テストスイート
- **リリース前**: パフォーマンステスト、セキュリティテスト

### 6.3 テストレポート
- カバレッジレポート（目標: 80%以上）
- パフォーマンスレポート
- セキュリティスキャン結果

## 7. テストデータ管理

### 7.1 テストデータセット
```python
TEST_PROJECTS = [
    {
        "folder_name": "test_basic",
        "project_name": "基本テストプロジェクト",
        "description": "APIテスト用の基本プロジェクト",
        "tags": ["テスト", "自動化"]
    },
    {
        "folder_name": "test_large",
        "project_name": "大規模テストプロジェクト",
        "description": "パフォーマンステスト用",
        "tags": ["パフォーマンス"],
        "file_count": 1000
    },
    {
        "folder_name": "test_unicode",
        "project_name": "ユニコードテスト项目",
        "description": "多言語対応テスト用",
        "tags": ["国際化", "テスト"]
    }
]
```

### 7.2 テストファイル
- 各種形式: CSV, JSON, XML, TXT, PDF, 画像
- サイズ別: 小（< 1MB）、中（1-10MB）、大（> 100MB）
- 特殊ケース: 0バイトファイル、破損ファイル

### 7.3 テストデータのクリーンアップ
- テスト実行後の自動削除
- テストプロジェクトの識別（test_プレフィックス）

## 8. 不具合管理

### 8.1 不具合の分類
- **Critical**: システム停止、データ損失
- **High**: 主要機能の不具合
- **Medium**: 副次的機能の不具合
- **Low**: UIの軽微な問題

### 8.2 不具合追跡
- Issue管理システム（GitHub Issues）
- バグレポートテンプレート
- 再現手順の記録

## 9. リスクと緩和策

### 9.1 技術的リスク
| リスク | 影響 | 緩和策 |
|--------|------|--------|
| 大量データ処理でのメモリ不足 | 高 | ページネーション実装、ストリーミング処理 |
| ファイルシステムの権限問題 | 中 | 適切な権限設定、エラーハンドリング |
| 同時アクセスによるデータ競合 | 高 | ロック機構、トランザクション処理 |

### 9.2 プロジェクトリスク
| リスク | 影響 | 緩和策 |
|--------|------|--------|
| テスト工数の不足 | 高 | 優先度付け、自動化推進 |
| 環境依存の問題 | 中 | Docker化、環境変数管理 |

## 10. 成功基準

### 10.1 品質メトリクス
- 単体テストカバレッジ: 80%以上
- APIテスト成功率: 100%
- 統合テスト成功率: 95%以上
- Critical/Highバグ: 0件
- Mediumバグ: 5件以下

### 10.2 パフォーマンスメトリクス
- API平均レスポンスタイム: < 1秒
- 同時接続数: 100以上
- アップタイム: 99.9%

### 10.3 セキュリティメトリクス
- 脆弱性スキャン: Critical 0件
- ペネトレーションテスト合格

## 11. テストスケジュール

### 11.1 フェーズ1: 基礎テスト（2週間）
- Week 1: 単体テスト実装
- Week 2: APIテスト実装

### 11.2 フェーズ2: 統合テスト（2週間）
- Week 3: 統合テスト実装
- Week 4: E2Eテスト実装

### 11.3 フェーズ3: 品質保証（1週間）
- Week 5: パフォーマンステスト、セキュリティテスト

### 11.4 フェーズ4: リリース準備（1週間）
- Week 6: バグ修正、回帰テスト

## 12. 付録

### 12.1 テストツール一覧
- **Python**: pytest, Django Test Framework, coverage.py
- **API**: Postman, Django REST framework test client
- **負荷**: Locust, JMeter
- **セキュリティ**: OWASP ZAP, Bandit
- **CI/CD**: GitHub Actions, Jenkins

### 12.2 参考資料
- Django Testing Documentation
- REST API Testing Best Practices
- OWASP Testing Guide
- プロジェクト仕様書（doc/APIja.md）