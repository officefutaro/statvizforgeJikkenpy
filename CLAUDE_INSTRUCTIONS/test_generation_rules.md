# テスト生成時の約束事

## 基本方針
テストコードの生成・作成時は以下の約束事を厳守する。

## 1. テストファイルの命名規則
- **バックエンド**: `test_*.py` 形式
- **フロントエンド**: `*.test.tsx` または `*.spec.ts` 形式
- 元のファイル名を基準とした命名
  - 例: `views.py` → `test_views.py`
  - 例: `FileExplorer.tsx` → `FileExplorer.test.tsx`

## 2. テスト内容の網羅性
### 必須テストケース
1. **正常系テスト**: 期待される動作の確認
2. **異常系テスト**: エラーハンドリングの確認
3. **境界値テスト**: 限界値での動作確認
4. **バリデーションテスト**: 入力検証の確認

### 機能別テストケース
- **API**: リクエスト/レスポンス、ステータスコード、エラーハンドリング
- **UI**: ユーザーインタラクション、表示/非表示、状態変化
- **データ処理**: 入力変換、計算結果、データ整合性

## 3. テストコードの品質基準
### 構造
- **Arrange**: テストデータの準備
- **Act**: テスト対象の実行
- **Assert**: 結果の検証

### 命名
- テスト関数名は処理内容を明確に表現
- 日本語でのテスト名も許可（`test_save_file_tags_success`）
- 目的が分かりやすいコメント追加

### データ
- **モックデータ**: 実際のデータ構造に準拠
- **テスト用プロジェクト**: `test_project` などの専用名称使用
- **一意性**: テスト間でのデータ競合回避

## 4. 技術的要件
### バックエンド (Django)
- `APITestCase` または `TestCase` の使用
- `@patch` デコレータでの外部依存関係モック
- `DjangoTestCaseMixin` の継承（利用可能な場合）
- レスポンス形式の検証（JSON構造、必須フィールド）

### フロントエンド (React/TypeScript)
- `@testing-library/react` の使用
- ユーザーインタラクション重視のテスト
- アクセシビリティを考慮したクエリ使用
- 非同期処理の適切な待機

## 5. プロジェクト固有のルール
### ファイルタグ機能
- タグバリデーションルールの確認
  - 分析データ → 時系列データ/項目データ (階層関係)
  - 参考資料 (独立)
- `file_tags.json` 形式での永続化テスト
- プロジェクトフォルダ構造の確認

### API仕様
- 多言語対応レスポンス
- エラーメッセージの国際化
- CORS設定の確認
- セキュリティ考慮事項

## 6. テストデータ管理
### 使用可能なテスト用プロジェクト
- `test_project`
- `minimal_test`
- `debug_test_project`

### プロジェクトフォルダ保護の徹底
**重要**: テスト前後でprojectフォルダの内容が変わらないことを保証する

#### 保護対象
- `project/` ディレクトリ全体
- 既存プロジェクトの `project.json`
- 既存プロジェクトの `file_tags.json`
- 既存プロジェクトの raw データファイル
- `projects-registry.json`

#### 保護手段
1. **テストデータの分離**
   - テスト専用の一時ディレクトリ使用
   - 既存プロジェクトフォルダへの直接操作禁止
   - テスト用プロジェクト名の使用（例: `test_project_12345`）

2. **バックアップ・復元システム**
   ```python
   # テスト前: バックアップ作成
   def setUp(self):
       super().setUp()
       self.backup_manager = ProjectBackupManager()
       self.backup_manager.create_backup()
   
   # テスト後: 復元実行
   def tearDown(self):
       self.backup_manager.restore_backup()
       super().tearDown()
   ```

3. **モックによる代替**
   - ファイルシステム操作のモック化
   - `pathlib.Path.exists()` のモック
   - `json.load()`, `json.dump()` のモック
   - API呼び出しの完全モック化

4. **テスト用ミックスイン活用**
   ```python
   from test_utils.project_backup import DjangoTestCaseMixin
   
   class MyTestCase(DjangoTestCaseMixin, APITestCase):
       # 自動的にバックアップ・復元が実行される
   ```

5. **一時ディレクトリの使用**
   ```python
   import tempfile
   import shutil
   
   def setUp(self):
       self.temp_dir = tempfile.mkdtemp()
       # テストデータを一時ディレクトリに配置
   
   def tearDown(self):
       shutil.rmtree(self.temp_dir)
   ```

6. **読み取り専用テスト**
   - 既存データの参照のみ
   - 変更を伴う操作は完全モック
   - アサーションは戻り値のみで実行

#### 検証方法
- テスト実行前後でのファイルハッシュ比較
- ディレクトリ構造の変更検出
- プロジェクト数の一致確認
- レジストリファイルの整合性確認

### 避けるべき事項
- 本番データの使用
- 既存プロジェクトフォルダへの直接書き込み
- ハードコードされた絶対パス
- タイムゾーン依存の日時比較
- 並行実行時の競合状態
- バックアップなしでの破壊的操作

## 7. 実行環境への配慮
### CI/CD対応
- 環境変数への依存最小化
- ファイルシステム操作の冪等性
- 並行実行時の安全性確保

### 開発環境
- ローカル開発での実行可能性
- 必要な依存関係の明示
- 設定ファイルでの調整可能性

## 8. メンテナンス性
### 更新しやすさ
- 設定変更時の影響範囲最小化
- 新機能追加時のテスト拡張容易性
- リファクタリング時の安全性確保

### ドキュメント
- テストケースの目的明記
- 複雑なロジックの説明追加
- 前提条件や制約事項の記載

## 9. パフォーマンス考慮
- 不要な重複テスト回避
- 効率的なモック使用
- テスト実行時間の最適化
- リソース使用量の適正化

## 10. セキュリティ考慮
- 機密情報のハードコード禁止
- テスト用認証情報の分離
- 権限テストの実装
- 入力検証の徹底確認