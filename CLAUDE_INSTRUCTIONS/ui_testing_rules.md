# UIテスト実行ルール

## 1. テストモードの使い分け

### ヘッドレスモード（毎日のルーチン）
- **実行タイミング**: 毎朝のルーチンワーク時に必ず実施
- **実行コマンド**: `npm run test:e2e`
- **目的**: 
  - 機能の正常動作確認
  - リグレッションテスト
  - CI/CD環境と同等の検証
- **特徴**:
  - バックグラウンドで実行
  - PC作業と並行可能
  - 高速実行

### ヘッドモード（新機能実装時）
- **実行タイミング**: 新機能実装完了時、ユーザーへの完了報告前に必ず実施
- **実行コマンド**: `npm run test:e2e -- --headed`
- **目的**:
  - 視覚的な確認
  - レイアウト崩れの検出
  - ユーザーインタラクションの検証
- **特徴**:
  - ブラウザウィンドウを表示
  - 実際のユーザー操作に近い環境
  - より高い検出率

## 2. テスト実行手順

### 毎日のルーチンワーク
1. 開発環境の起動確認
   ```bash
   ./start-dev.sh
   ```

2. E2Eテスト（ヘッドレス）の実行
   ```bash
   cd /home/futaro/project/StatVizForge_JikkenPy/app/frontend
   npm run test:e2e
   ```

3. エラーがある場合は修正して再実行

4. テスト結果を記録
   - `doc/history/test_YYYYMMDD.md`に結果を記載

### 新機能実装時
1. 機能実装完了後、ユニットテストを実行
   ```bash
   npm test
   ```

2. E2Eテスト（ヘッドモード）を実行
   ```bash
   npm run test:e2e -- --headed
   ```

3. 視覚的な問題を確認
   - レイアウト崩れ
   - アニメーション不具合
   - インタラクション問題

4. 全テスト合格を確認してからユーザーに報告

## 3. テストエラー時の対応

### デバッグモードの活用
問題の詳細調査が必要な場合：
```bash
npm run test:e2e -- --debug
```

### UIモードでの確認
特定のテストを繰り返し実行する場合：
```bash
npm run test:e2e -- --ui
```

### スクリーンショット・ビデオの確認
失敗時の証跡は以下に保存：
- スクリーンショット: `test-results/`
- ビデオ: `test-results/`
- HTMLレポート: `playwright-report/`

## 4. テスト結果の記録

### 必須記録項目
- 実行日時
- テストモード（ヘッドレス/ヘッド）
- 実行結果（成功/失敗）
- 失敗した場合の詳細
- 修正内容
- 再実行結果

### 記録ファイル
- 日次テスト: `doc/history/test_YYYYMMDD.md`
- 新機能テスト: `doc/history/feature_test_YYYYMMDD.md`

## 5. 注意事項

### ヘッドモード実行時
- テスト中はマウスやキーボードの操作を避ける
- 他のブラウザウィンドウを閉じておく
- 十分な画面解像度を確保

### プロジェクトデータ保護
- テスト実行前後でプロジェクトデータの変更がないことを確認
- `test-utils/e2e-globalSetup.ts`でバックアップが実行される
- `test-utils/e2e-globalTeardown.ts`でリストアが実行される

### パフォーマンス
- ヘッドレスモードはヘッドモードより約30-50%高速
- 並列実行は無効化（データ保護のため）
- タイムアウトは30秒に設定