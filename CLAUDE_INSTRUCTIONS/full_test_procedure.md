# 夜間実行フルテスト手順書

## 概要
夜間実行フルテストは、ユーザーの就寝中に完全なテストを自動実行し、品質保証と自動修正を行うための手順です。

## フルテストの定義

### 1. 実行タイミング
- **推奨時間**: 深夜0時〜朝6時
- **実行頻度**: 週1回または重要な変更後
- **制限**: 時間制限なし（完了まで実行）

### 2. テスト範囲

#### 2.1 ユニットテスト
- バックエンド: `python manage.py test`
- フロントエンド: `npm test`

#### 2.2 統合テスト
- API整合性テスト
- データベース整合性テスト
- ファイルシステム整合性テスト

#### 2.3 E2Eテスト
- **ヘッドレスモード**: 全テストケース実行
- **ヘッドモード**: 新機能・変更機能のテスト
- スクリーンショット・ビデオ記録を保存

#### 2.4 パフォーマンステスト
- API応答時間測定
- ページロード時間測定
- メモリ使用量確認

#### 2.5 セキュリティテスト
- 基本的なセキュリティチェック
- 依存関係の脆弱性スキャン

## 自動修正ポリシー

### 3. 許可不要な自動修正（即座に実行）

#### 3.1 コード品質
- **Lintエラー修正**: ESLint, Prettierによる自動フォーマット
- **型エラー修正**: TypeScript型定義の自動修正
- **未使用インポート削除**: 自動クリーンアップ
- **コメント整理**: 不要なコメントの削除

#### 3.2 テスト関連
- **data-testid属性追加**: E2Eテストで必要な属性の自動追加
- **テストタイムアウト調整**: 必要に応じて延長
- **モックデータ更新**: テストデータの自動更新

#### 3.3 ドキュメント
- **API仕様書更新**: 実装と一致するよう自動更新
- **型定義ファイル生成**: TypeScript型定義の自動生成
- **テスト結果記録**: 自動的にログファイルへ記録

#### 3.4 設定ファイル
- **設定値の正規化**: 不整合な設定値の修正
- **デフォルト値設定**: 未設定項目へのデフォルト値適用
- **廃止設定の削除**: 使用されていない設定の削除

### 4. 許可が必要な修正（記録して後日確認）

#### 4.1 重大な変更
- **APIエンドポイント変更**: URLパスの変更
- **データベーススキーマ変更**: テーブル構造の変更
- **ビジネスロジック変更**: 処理フローの変更

#### 4.2 削除操作
- **ファイル削除**: 未使用ファイルの削除提案
- **機能削除**: 廃止予定機能の削除提案
- **依存関係削除**: 未使用パッケージの削除提案

#### 4.3 パフォーマンス改善
- **クエリ最適化**: N+1問題の解決提案
- **キャッシュ追加**: パフォーマンス改善のためのキャッシュ提案
- **インデックス追加**: データベースインデックスの提案

## 実行手順

### 5. フルテスト実行コマンド

```bash
# フルテスト開始
./run-full-test.sh

# オプション付き実行
./run-full-test.sh --include-head-test --no-time-limit --auto-fix
```

### 6. 実行フロー

1. **環境準備**
   - プロジェクトデータのバックアップ
   - テスト用ブランチの作成
   - 依存関係の更新確認

2. **テスト実行**
   - ユニットテスト実行
   - 統合テスト実行
   - E2Eテスト（ヘッドレス）実行
   - E2Eテスト（ヘッド）実行
   - パフォーマンステスト実行
   - セキュリティテスト実行

3. **自動修正**
   - 許可不要な修正を即座に適用
   - 修正内容をコミット
   - 修正後の再テスト実行

4. **結果記録**
   - テスト結果を`doc/history/full_test_YYYYMMDD.md`に記録
   - 許可が必要な修正を`doc/history/pending_fixes_YYYYMMDD.md`に記録
   - スクリーンショット・ビデオを保存

5. **ブランチ統合**
   - テストブランチをmainブランチにマージ
   - コミットメッセージ: `夜間フルテスト実行と自動修正 - YYYY-MM-DD`
   - GitHubへプッシュ

### 7. 出力ファイル

#### 7.1 テスト結果
- `doc/history/full_test_YYYYMMDD.md` - 完全なテスト結果
- `doc/history/pending_fixes_YYYYMMDD.md` - 許可待ち修正リスト
- `test-results/full-test-YYYYMMDD/` - スクリーンショット・ビデオ

#### 7.2 ログファイル
- `logs/full-test-YYYYMMDD.log` - 実行ログ
- `logs/auto-fix-YYYYMMDD.log` - 自動修正ログ

### 8. 翌朝の確認事項

1. **テスト結果確認**
   - 全体の成功率
   - 失敗したテストの詳細
   - パフォーマンス指標

2. **自動修正確認**
   - 適用された修正の一覧
   - 修正による改善効果

3. **許可待ち修正の確認**
   - 提案された修正の評価
   - 承認/却下の判断

## 設定ファイル

### 9. フルテスト設定

```json
{
  "fullTest": {
    "timeLimit": null,
    "includeHeadTest": true,
    "autoFix": {
      "enabled": true,
      "categories": [
        "lint",
        "typeError",
        "testId",
        "documentation",
        "configuration"
      ]
    },
    "notification": {
      "onComplete": true,
      "onError": true
    },
    "backup": {
      "enabled": true,
      "keepDays": 7
    }
  }
}
```

## 注意事項

### 10. 実行前の確認
- 十分なディスク容量（最低10GB推奨）
- インターネット接続の安定性
- 他の自動処理との競合がないこと

### 11. エラー時の対応
- 自動的にロールバック処理を実行
- エラーログを保存
- 翌朝確認できるよう通知

### 12. セキュリティ考慮
- プロダクション環境では実行しない
- 機密データを含むテストは暗号化
- プッシュ前にセキュリティスキャン実施