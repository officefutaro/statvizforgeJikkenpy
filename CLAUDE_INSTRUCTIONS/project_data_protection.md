# プロジェクトデータ保護ガイドライン

## 概要
プロジェクトフォルダ内のデータ（コメント、タグ、メタデータ）の消失を防ぐための保護策とベストプラクティス。

## 保護対象データ
- `file_comments.json` - ファイルコメントデータ
- `file_tags.json` - ファイルタグデータ
- `project.json` - プロジェクト基本情報
- `analysisdata/` - 分析結果とメタデータ
- `raw/` - 生データファイル

## 実装済み保護策

### 1. プロジェクト作成時の初期化保護
**実装場所**: `api/views.py:_create_project_folder_structure()`

- 新規プロジェクト作成時に`file_comments.json`を自動作成
- 空の初期構造で作成することで、後続の操作時にファイル存在を保証

```json
{
  "version": "1.0.0",
  "created": "2025-07-31T...",
  "last_updated": "2025-07-31T...",
  "comments": {}
}
```

### 2. プロジェクトフォルダ名変更時の保護
**実装場所**: `api/views.py:update()`, `_handle_folder_rename()`

- フォルダ名変更時にプロジェクトフォルダ全体を原子的にリネーム
- コメントファイル、タグファイル、その他メタデータを完全保持
- `shutil.move()`による安全なフォルダ移動

### 3. プロジェクト削除時の保護
**実装場所**: `api/views.py:destroy()`, `_archive_project()`

- 削除前に全データをzipアーカイブとして保存
- `project/trash/`フォルダに完全バックアップを作成
- `trash-registry.json`で削除履歴を管理

## 保護されるシナリオ

### ✅ 保護済み
1. **プロジェクト新規作成** → コメントファイル自動作成
2. **プロジェクト名変更** → データ完全保持
3. **フォルダ名変更** → フォルダ全体移動でデータ保持
4. **プロジェクト削除** → zipアーカイブで完全バックアップ

### ⚠️ 注意が必要
1. **直接ファイルシステム操作** → API経由でない変更は保護対象外
2. **並行処理での競合** → 同時更新時の競合状態
3. **ディスク容量不足** → アーカイブ作成失敗の可能性

## データ消失を防ぐベストプラクティス

### 開発者向け
1. **プロジェクト操作は必ずAPI経由で実行**
2. **フォルダ名変更時は`_handle_folder_rename()`メソッドを使用**
3. **新機能追加時はデータ保護を考慮した設計**

### システム管理者向け
1. **定期的な`project/`フォルダのバックアップ**
2. **`project/trash/`の容量監視**
3. **ログファイルでの操作履歴確認**

## 復旧手順

### コメントデータ消失時
1. `project/trash/`でアーカイブファイルを確認
2. 該当するzipファイルから`file_comments.json`を抽出
3. プロジェクトフォルダに復元

### プロジェクト全体消失時
1. `project/trash/trash-registry.json`で削除履歴を確認
2. 該当アーカイブをunzip
3. `project/`フォルダに復元
4. `projects-registry.json`にプロジェクト情報を再登録

## 監視とアラート

### 監視すべき項目
- `file_comments.json`の存在確認
- プロジェクトフォルダの整合性
- アーカイブ作成の成功/失敗

### ログ出力
- フォルダリネーム操作
- アーカイブ作成結果
- データ保護処理の実行状況

## 今後の改善予定

### 追加実装予定
1. **データ整合性チェック機能**
2. **自動バックアップ機能**
3. **復旧コマンドの自動化**
4. **リアルタイム監視システム**

---

**最終更新**: 2025年7月31日  
**対応バージョン**: API v1.0以降